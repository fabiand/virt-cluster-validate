#!/usr/bin/bash

#mkdir /tmp/app
#pushd /tmp/app

#curl -sL http://downloads.openshift-console.svc.cluster.local/amd64/linux/oc.tar | tar xf -
#curl -sL http://hyperconverged-cluster-cli-download.openshift-cnv.svc.cluster.local:8080/amd64/linux/virtctl.tar.gz | tar xfz -
export PATH=$PATH:$PWD

c() { echo "# $@" ; }
n() { echo "" ; }
x() { echo "\$ $@" ; eval "$@" ; }
red() { echo -e "\e[0;31m$@\e[0m" ; }
green() { echo -e "\e[0;32m$@\e[0m" ; }
die() { red "FATAL: $@" ; exit 1 ; }
assert() { echo "(assert:) \$ $@" ; eval $@ || { echo "(assert?) FALSE" ; die "Assertion ret 0 failed: '$@'" ; } ; green "(assert?) True" ; }

#      oc get -n openshift-cnv hyperconverged hyperconverged

BUILT_PLUGINS_INDEX="checks.d/generated-plugin-index.txt"

main() {
  c "Starting validation ..."
  if [[ -f "$BUILT_PLUGINS_INDEX" ]];
  then
      main_with_containers
  else
    set -m  # job control
    PLUGIN_FILTER="${1:-*}"
    PLUGINS=$(ls -1d checks.d | grep -E "$PLUGIN_FILTER" | sort)
    for PLUGIN in $PLUGINS
    do
      PLUGIN_RESULTS="$RESULTSD/$(echo $PLUGIN | tr "/:.-" "____").d/"
      mkdir -p $PLUGIN_RESULTS
      (
          $PLUGIN
      ) > $PLUGIN_RESULTS/cmdline 2>&1 &
    done

    c "Waiting for jobs to complete" 
    wait -f
  fi

  c "All jobs completed. Summarizing."
  cat ${RESULTSD}/*/result.json \
  | jq -s . \
  | jq '{apiVersion: "validate.kubevirt.io/v1alpha1", kind: "Results", items: .}' \
  | tee ${RESULTSD}/result.json \
  | pprint

}

main_with_containers() {
  local PLUGIN_FILTER="${1:-*}"
  local PLUGINS=$(cat checks.d/generated-plugin-index.txt | grep -E "$PLUGIN_FILTER" | sort)
  local RESULTSD=$PWD/results.d/

  set -m  # job control
  for PLUGIN in $PLUGINS
  do
    PLUGIN_RESULTS="$RESULTSD/$(echo $PLUGIN | tr "/:.-" "____").d/"
    mkdir -p $PLUGIN_RESULTS
    c "Dispatching '$PLUGIN' ..."
    (
    set -x
    podman -r run \
        --rm \
        --volume $PLUGIN_RESULTS:/results.d:rw,z \
        --volume $HOME/.kube:/.kube:ro,z \
        --volume $(which oc):/usr/bin/oc:ro,bind,exec,z \
        --volume $(which virtctl):/usr/bin/virtctl:ro,bind,exec,z \
        $PLUGIN
    ) > $PLUGIN_RESULTS/cmdline 2>&1 &
  done

  c "Waiting for jobs to complete" 
  wait -f
  c "All jobs completed."
}

pprint() {
#  if [[ -n "$AS_JSON" ]];
#  then
#    jq
#  else
    jq -r '
    .items[]
           | if .pass == false or .step == "" 
             then [if .pass == true then "PASS" else "FAIL" end, "-", .displayname, if .step != "" then ["/", .step, "-", .message] | join(" ") else "" end] 
             else ["      ", .displayname, "/", .step, "-", .level, "-", .message ] end
           | join(" ")'
#  fi
}

main $@
